<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>AR Treasure Hunt ‚Äî Sacr√© Coeur</title>

  <!-- A-Frame + AR.js (AR.js 3.4.7) -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <style>
    :root { --fg:#e7eefb; --muted:#97a3b6; --ok:#22c55e; --brand:#0ea5e9; }
    html,body{margin:0;padding:0;background:#000;color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Inter,Arial;overflow:hidden}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:9999}
    .panel{background:rgba(15,23,42,.9);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;max-width:min(92vw,560px)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:linear-gradient(135deg,var(--brand),#6366f1);color:#fff;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    select{padding:8px;border-radius:10px;background:#0b1224;color:#fff;border:1px solid rgba(255,255,255,.16);min-width:220px}
    .muted{color:var(--muted);font-size:.95rem}
    .hud{position:fixed;inset:0;pointer-events:none;z-index:9990}
    .top{position:absolute;left:12px;right:12px;top:12px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .card{pointer-events:auto;background:rgba(11,16,32,.58);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:10px 12px}
    .pills{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:6px 10px;border:1px solid rgba(255,255,255,.12)}
    .pill .dot{font-weight:900}
    .timer{font-variant-numeric:tabular-nums}
    .help{position:absolute;right:12px;bottom:12px;max-width:min(92vw,480px)}
    .final{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:10000}
    .final.show{display:flex}
    .final .box{background:linear-gradient(180deg,rgba(15,23,42,.95),rgba(15,23,42,.8));border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:22px 20px;width:min(92vw,560px);text-align:center}
  </style>
</head>
<body>
  <!-- Pantalla de arranque: permiso + selecci√≥n de c√°mara -->
  <div class="overlay" id="gate">
    <div class="panel">
      <h3>Laboratorio: B√∫squeda del Tesoro (AR.js)</h3>
      <p class="muted">Abr√≠ esta p√°gina por <b>HTTPS</b> o <b>localhost</b>. Eleg√≠ c√°mara y toc√° <b>Empezar</b>.</p>
      <div class="row">
        <label for="camSel">C√°mara:</label>
        <select id="camSel"><option value="">Buscando c√°maras‚Ä¶</option></select>
        <button class="btn" id="btnStart">Empezar</button>
      </div>
      <div class="row"><small class="muted" id="diag"></small></div>
      <details style="margin-top:8px">
        <summary>¬øC√≥mo jugar?</summary>
        <ul class="muted">
          <li>Escane√° 3 marcadores: <b>Hiro</b>, <b>Kanji</b> y <b>Barcode 5</b>.</li>
          <li>Al ver cada marcador aparece una pista distinta.</li>
          <li>Complet√° los 3 para revelar el <b>tesoro</b>.</li>
        </ul>
      </details>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud" aria-hidden="true">
    <div class="top">
      <div class="card">
        <div class="muted">Progreso: <span id="progress">0</span>/3</div>
      </div>
      <div class="card pills">
        <span class="pill" id="p-hiro">Hiro <span class="dot">‚Ä¢</span></span>
        <span class="pill" id="p-kanji">Kanji <span class="dot">‚Ä¢</span></span>
        <span class="pill" id="p-bc5">Barcode 5 <span class="dot">‚Ä¢</span></span>
        <span class="pill timer" id="timer">00:00</span>
      </div>
    </div>
    <div class="help">
      <div class="card muted">Apunt√° a los marcadores impresos. Si ves fondo negro, cambi√° de c√°mara.</div>
    </div>
  </div>

  <!-- Feedback final -->
  <div class="final" id="final">
    <div class="box">
      <h2>üéâ ¬°Tesoro encontrado! üéâ</h2>
      <p>Tiempo total: <b id="finalTime">--:--</b></p>
      <button class="btn" onclick="document.getElementById('final').classList.remove('show')">Cerrar</button>
    </div>
  </div>

  <script>
    // ===== Helpers UI =====
    const $ = s => document.querySelector(s);
    const log = msg => { console.log('[AR]', msg); const d=$('#diag'); if(d) d.textContent=msg; };

    // ===== Estado de juego =====
    const MARKERS = ['hiro','kanji','bc5']; // bc5 = barcode 5
    const found = new Set();
    let startTs = null, timerId = null;
    function startTimer(){ if(startTs!==null) return; startTs=Date.now(); timerId=setInterval(()=>{const s=Math.floor((Date.now()-startTs)/1000); $('#timer').textContent = `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;},250); }
    function stopTimer(){ if(timerId){ clearInterval(timerId); timerId = null; } }
    function markFound(id){
      if(found.has(id)) return;
      found.add(id);
      if(found.size===1) startTimer();
      // P√≠ldoras
      const pill = id==='hiro' ? '#p-hiro' : id==='kanji' ? '#p-kanji' : '#p-bc5';
      const dot = document.querySelector(pill + ' .dot');
      if(dot){ dot.textContent = '‚úî'; dot.style.color='var(--ok)'; }
      $('#progress').textContent = found.size;
      // Sonidito (WebAudio) al encontrar
      try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.02); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.25); o.stop(ctx.currentTime+0.26);}catch(_){}
      if(found.size===MARKERS.length){
        stopTimer();
        $('#finalTime').textContent = $('#timer').textContent;
        $('#final').classList.add('show');
      }
    }

    // ===== C√°mara =====
    let chosenDeviceId = null;
    async function listCameras(){
      try{ await navigator.mediaDevices.getUserMedia({video:true}); } catch(_){}
      const devs = await navigator.mediaDevices.enumerateDevices();
      const cams = devs.filter(d=>d.kind==='videoinput');
      const sel = $('#camSel'); sel.innerHTML='';
      // Ordenar priorizando trasera por etiqueta
      cams.sort((a,b)=> (/(back|rear|environment)/i.test(a.label)?-1:0) - (/(back|rear|environment)/i.test(b.label)?-1:0));
      cams.forEach((c,i)=>{ const opt=document.createElement('option'); opt.value=c.deviceId; opt.textContent=c.label || `C√°mara ${i+1}`; sel.appendChild(opt); });
      if(cams.length){ chosenDeviceId = cams[0].deviceId; sel.value = chosenDeviceId; }
      sel.addEventListener('change', e => chosenDeviceId = e.target.value);
      return cams.length>0;
    }

    async function probe(deviceId){
      // Abrimos un stream breve solo para validar que haya frames
      const constraints = deviceId ? { video: { deviceId: { exact: deviceId } }, audio:false }
                                   : { video: { facingMode: { ideal: 'environment' } }, audio:false };
      const s = await navigator.mediaDevices.getUserMedia(constraints);
      // Chequear que entregue video (onloadedmetadata)
      const v = document.createElement('video');
      v.muted = true; v.playsInline = true; v.autoplay = true;
      v.srcObject = s; await v.play().catch(()=>{});
      await new Promise((res,rej)=>{ let done=false; const to=setTimeout(()=>!done&&rej(new Error('timeout video')),3500); v.onloadedmetadata=()=>{ if(done) return; done=true; clearTimeout(to); res(); }; });
      const ok = v.videoWidth>0 && v.videoHeight>0;
      s.getTracks().forEach(t=>t.stop());
      if(!ok) throw new Error('video sin frames');
    }

    // ===== AR Scene =====
    function buildScene({ facingMode='environment', deviceId=null }={}){
      // Limpieza previa si hubiera
      const old = document.getElementById('scene');
      if(old){ old.parentNode.removeChild(old); }

      const scene = document.createElement('a-scene');
      scene.setAttribute('id','scene');
      scene.setAttribute('embedded','');
      scene.setAttribute('renderer','antialias:true; alpha:false; precision:mediump; powerPreference:high-performance');

      // AR.js config
      // Usamos sourceType:webcam, detection mono + matrix (para barcode), y resoluciones t√≠picas m√≥viles
      const base = `trackingMethod: best; sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; sourceWidth:1280; sourceHeight:720; displayWidth:1280; displayHeight:720; debugUIEnabled:false`;
      // facingMode preferido; si hay deviceId lo dejamos a AR.js (usar√° el actual por permisos)
      scene.setAttribute('arjs', `${base}; ${deviceId ? '' : ('facingMode:'+facingMode+';')}`);

      // 3 marcadores con pistas distintas
      scene.innerHTML = `
        <a-marker id="m-hiro" preset="hiro" emitevents="true">
          <a-box color="#fb923c" depth="0.3" height="0.3" width="0.3" position="0 0.3 0"></a-box>
          <a-text value="Pista 1: Port√≥n principal" color="#fff" position="0 0.75 0" scale="0.45 0.45 0.45" align="center"></a-text>
        </a-marker>

        <a-marker id="m-kanji" preset="kanji" emitevents="true">
          <a-sphere color="#60a5fa" radius="0.22" position="0 0.28 0"></a-sphere>
          <a-text value="Pista 2: Patio interior" color="#fff" position="0 0.75 0" scale="0.45 0.45 0.45" align="center"></a-text>
        </a-marker>

        <a-marker id="m-bc5" type="barcode" value="5" emitevents="true">
          <a-cone color="#22c55e" position="0 0.3 0" radius-bottom="0.22" radius-top="0.05" height="0.42"></a-cone>
          <a-text value="Pista 3: Biblioteca" color="#fff" position="0 0.78 0" scale="0.45 0.45 0.45" align="center"></a-text>
        </a-marker>

        <!-- C√°mara -->
        <a-entity camera></a-entity>
      `;

      // Eventos AR √∫tiles
      scene.addEventListener('arReady', ()=>log('AR listo'));
      scene.addEventListener('arError', e=>log('AR error: '+(e?.detail?.message||'desconocido')));
      scene.addEventListener('camera-init', ()=>log('C√°mara inicializada por AR.js'));
      scene.addEventListener('camera-error', ()=>log('AR.js no pudo abrir la c√°mara'));

      scene.addEventListener('loaded', ()=>{
        // Conectar detecci√≥n de marcadores
        const bind = (id, key) => {
          const el = document.getElementById(id);
          if(!el) return;
          el.addEventListener('markerFound', ()=>markFound(key));
        };
        bind('m-hiro','hiro');
        bind('m-kanji','kanji');
        bind('m-bc5','bc5');
      });

      document.body.appendChild(scene);

      // Resize estable
      function safeResize(){ try{ scene && scene.resize && scene.resize(); } catch(_){ } }
      window.addEventListener('resize', ()=>setTimeout(safeResize,180));
      window.addEventListener('orientationchange', ()=>setTimeout(safeResize,260));
    }

    // ===== Flujo de arranque =====
    async function init(){
      // Contexto seguro recomendado
      const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
      if(!secure) log('Sugerencia: us√° HTTPS/localhost para evitar bloqueos de c√°mara.');
      await listCameras();
    }

    $('#btnStart').addEventListener('click', async ()=>{
      const btn = $('#btnStart');
      btn.disabled = true; btn.textContent = 'Chequeando c√°mara‚Ä¶';
      try{
        // Probar dispositivo elegido (si no hay, usar facingMode environment)
        if(chosenDeviceId){ await probe(chosenDeviceId); }
        else { await probe(null); }

        // Ocultar gate y construir escena (preferir environment; con deviceId tambi√©n funciona)
        $('#gate').style.display = 'none';
        buildScene({ facingMode:'environment', deviceId: chosenDeviceId });

      }catch(err){
        console.error(err);
        log('No se pudo abrir v√≠deo utilizable. Prob√° otra c√°mara o revis√° permisos.');
        btn.disabled = false; btn.textContent = 'Empezar';
      }
    });

    init();
  </script>
</body>
</html>
