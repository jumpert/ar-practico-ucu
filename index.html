<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>AR Treasure Hunt ‚Äî Sacr√© Coeur</title>

  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

  <style>
    :root { --fg:#e7eefb; --muted:#97a3b6; --ok:#22c55e; }
    html,body{margin:0;padding:0;background:#000;font-family:system-ui,Segoe UI,Roboto,Inter,Arial;color:var(--fg);overflow:hidden}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:9999}
    .panel{background:rgba(15,23,42,.85);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px 14px;max-width:min(92vw,560px)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;background:linear-gradient(135deg,#0ea5e9,#6366f1);color:#fff;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    select{padding:8px;border-radius:8px;background:#10172a;color:#fff;border:1px solid rgba(255,255,255,.12)}
    .hud{position:fixed;inset:0;pointer-events:none;z-index:9990}
    .top{position:absolute;left:12px;right:12px;top:12px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .card{pointer-events:auto;background:rgba(11,16,32,.6);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 12px}
    .muted{color:var(--muted);font-size:.9rem}
    .pills{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:6px 10px;border:1px solid rgba(255,255,255,.12)}
    .pill .dot{font-weight:700}
    .timer{font-variant-numeric:tabular-nums}
    .help{position:absolute;right:12px;bottom:12px;max-width:min(92vw,460px)}
    .final{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:10000}
    .final.show{display:flex}
    .final .box{background:linear-gradient(180deg,rgba(15,23,42,.92),rgba(15,23,42,.78));border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:22px 20px;width:min(92vw,560px);color:#fff;text-align:center}
    /* V√≠deo de prueba (solo se ve si se destapa debug) */
    #probeVideo{position:fixed;right:8px;bottom:8px;width:160px;height:90px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.2);display:none;z-index:9991}
  </style>
</head>
<body>
  <!-- Arranque / permiso / selecci√≥n de c√°mara -->
  <div class="overlay" id="gate">
    <div class="panel">
      <div id="gateMsg">Para comenzar, eleg√≠ la c√°mara y activ√° el acceso. (Recomendado abrir por <b>HTTPS</b> o <b>localhost</b>)</div>
      <div class="row">
        <label for="camSel">C√°mara:</label>
        <select id="camSel"><option value="">(buscando‚Ä¶)</option></select>
        <button class="btn" id="btnStart">Activar c√°mara</button>
      </div>
      <div class="row">
        <small class="muted" id="diag"></small>
      </div>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud">
    <div class="top">
      <div class="card">
        <div class="muted">Progreso <span id="progressCount">0</span>/3</div>
      </div>
      <div class="card pills">
        <span class="pill" id="status-m-hiro">Hiro <span class="dot">‚Ä¢</span></span>
        <span class="pill" id="status-m-kanji">Kanji <span class="dot">‚Ä¢</span></span>
        <span class="pill" id="status-m-bar5">Barcode 5 <span class="dot">‚Ä¢</span></span>
        <span class="pill timer" id="timer">00:00</span>
      </div>
    </div>
    <div class="help">
      <div class="card">
        <div class="muted">Apunt√° la c√°mara a los marcadores: <b>Hiro</b>, <b>Kanji</b> y <b>Barcode 5</b></div>
      </div>
    </div>
  </div>

  <!-- Modal final -->
  <div class="final" id="final">
    <div class="box">
      <h2>üéâ ¬°Tesoro encontrado! üéâ</h2>
      <p>Completaste las 3 pistas en <strong id="finalTime">--:--</strong>.</p>
      <button class="btn" onclick="document.getElementById('final').classList.remove('show')">Cerrar</button>
    </div>
  </div>

  <!-- V√≠deo de prueba (para descartar fondo negro por stream nulo). Si quer√©s, activ√° l√≠nea display:block. -->
  <video id="probeVideo" playsinline muted autoplay></video>

  <!-- La escena AR se inyecta luego del OK real de c√°mara -->
  <script>
    const $ = s => document.querySelector(s);
    const diag = msg => { const el = $('#diag'); if (el) el.textContent = msg; console.log('[AR-DIAG]', msg); };

    // ====== Estado ======
    const markers = ['m-hiro','m-kanji','m-bar5'];
    const found = new Set();
    let startTs = null, tId = null, sceneBuilt = false, sceneEl = null;
    let chosenDeviceId = null;

    // ====== HUD & Timer ======
    function startTimer(){ if(startTs!==null) return; startTs=Date.now(); tId=setInterval(()=>{const s=Math.floor((Date.now()-startTs)/1000); $('#timer').textContent=`${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;},250);}
    function stopTimer(){ if(tId){clearInterval(tId); tId=null;} }
    function updateHUD(){ $('#progressCount').textContent=found.size; for(const id of markers){const pill=$('#status-'+id); const dot=pill&&pill.querySelector('.dot'); if(dot&&found.has(id)){dot.textContent='‚úî'; dot.style.color='var(--ok)';}}}
    function onFound(id){
      if(found.has(id)) return;
      found.add(id); updateHUD();
      if(found.size===1) startTimer();
      if('vibrate' in navigator) navigator.vibrate(60);
      if(found.size===markers.length){
        stopTimer();
        $('#finalTime').textContent=$('#timer').textContent;
        $('#final').classList.add('show');
        try{localStorage.setItem('sacre_ar_last',JSON.stringify({done:true,time:$('#timer').textContent,at:new Date().toISOString()}));}catch(_){}
      }
    }

    // ====== Utils c√°mara ======
    async function listCameras(){
      try{
        await navigator.mediaDevices.getUserMedia({video:true}); // para poder obtener labels
      }catch(_){}
      const devs = await navigator.mediaDevices.enumerateDevices();
      const cams = devs.filter(d=>d.kind==='videoinput');
      const sel = $('#camSel'); sel.innerHTML='';
      // Intentar trasera primero por label
      const backFirst = [...cams].sort((a,b)=>{
        const ab = /back|rear|environment/i.test(a.label) ? -1 : 0;
        const bb = /back|rear|environment/i.test(b.label) ? -1 : 0;
        return ab-bb;
      });
      backFirst.forEach((c,i)=>{
        const opt=document.createElement('option');
        opt.value=c.deviceId;
        opt.textContent=c.label||`C√°mara ${i+1}`;
        sel.appendChild(opt);
      });
      if(backFirst.length){ chosenDeviceId=backFirst[0].deviceId; sel.value=chosenDeviceId; }
      sel.addEventListener('change',e=>{ chosenDeviceId=e.target.value; });
      return backFirst;
    }

    // Verifica que el stream entrega frames (evita ‚Äúfondo negro‚Äù por stream sin datos)
    async function probeCamera(deviceId){
      const pv = $('#probeVideo');
      const constraints = { video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: { ideal: 'environment' } }, audio:false };
      let stream;
      try{
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      }catch(err){
        diag('No fue posible abrir la c√°mara seleccionada. Intento con frontal‚Ä¶');
        // fallback a frontal
        try{
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio:false });
        }catch(err2){
          throw err2;
        }
      }
      pv.srcObject = stream;
      pv.play().catch(()=>{});
      // Esperar a que cargue metadatos y haya tama√±o > 0
      await new Promise((res,rej)=>{
        let done=false;
        const to=setTimeout(()=>{ if(!done) rej(new Error('timeout-video')); }, 4000);
        pv.onloadedmetadata=()=>{ if(done) return; done=true; clearTimeout(to); res(); };
      });
      if (!pv.videoWidth || !pv.videoHeight){ throw new Error('video-without-frames'); }
      // Ocultar el video de prueba (destapalo si quer√©s ver el feed crudo)
      pv.style.display='none'; 
      // Parar tracks (AR.js abrir√° su propio stream)
      stream.getTracks().forEach(t=>t.stop());
      return true;
    }

    // ====== Construir escena AR s√≥lo si la c√°mara es v√°lida ======
    function buildScene(){
      if(sceneBuilt) return; sceneBuilt=true;
      sceneEl = document.createElement('a-scene');
      sceneEl.setAttribute('id','scene');
      // alpha:false evita transparencia total negra en algunos m√≥viles
      sceneEl.setAttribute('renderer','antialias:true; alpha:false; precision:mediump; powerPreference:high-performance');
      sceneEl.setAttribute('embedded','');

      // Config AR.js: fijamos tama√±os comunes 1280x720 para m√≥viles y detection mono+matrix
      // facingMode environment ayuda, pero ya probamos la c√°mara antes
      sceneEl.setAttribute('arjs','trackingMethod: best; sourceType: webcam; facingMode: environment; detectionMode: mono_and_matrix; matrixCodeType: 3x3; sourceWidth:1280; sourceHeight:720; displayWidth:1280; displayHeight:720; debugUIEnabled:false');

      sceneEl.innerHTML = `
        <a-marker id="m-hiro" preset="hiro" emitevents="true">
          <a-box color="#f97316" depth="0.3" height="0.3" width="0.3" position="0 0.3 0"></a-box>
          <a-text value="Pista 1" color="#fff" position="0 0.7 0" scale="0.4 0.4 0.4" align="center"></a-text>
        </a-marker>
        <a-marker id="m-kanji" preset="kanji" emitevents="true">
          <a-sphere color="#3b82f6" radius="0.2" position="0 0.3 0"></a-sphere>
          <a-text value="Pista 2" color="#fff" position="0 0.7 0" scale="0.4 0.4 0.4" align="center"></a-text>
        </a-marker>
        <a-marker id="m-bar5" type="barcode" value="5" emitevents="true">
          <a-cone color="#22c55e" position="0 0.3 0" radius-bottom="0.2" radius-top="0.05" height="0.4"></a-cone>
          <a-text value="Pista 3" color="#fff" position="0 0.7 0" scale="0.4 0.4 0.4" align="center"></a-text>
        </a-marker>
        <a-entity camera></a-entity>
      `;

      // Diagn√≥stico √∫til
      sceneEl.addEventListener('arReady', ()=>diag('AR listo.'));
      sceneEl.addEventListener('arError', e=>diag('Error AR: '+ (e?.detail?.message||'desconocido')));
      sceneEl.addEventListener('camera-init', ()=>diag('C√°mara inicializada por AR.js.'));
      sceneEl.addEventListener('camera-error', e=>diag('AR.js no pudo abrir la c√°mara (revis√° permisos/HTTPS).'));

      sceneEl.addEventListener('loaded', ()=>{
        for(const id of markers){
          const el=document.getElementById(id);
          if(el) el.addEventListener('markerFound', ()=>onFound(id));
        }
      });

      document.body.appendChild(sceneEl);

      function safeResize(){ try{ sceneEl && sceneEl.resize && sceneEl.resize(); }catch(_){ } }
      window.addEventListener('resize', ()=>setTimeout(safeResize,200));
      window.addEventListener('orientationchange', ()=>setTimeout(safeResize,300));
    }

    // ====== Flujo principal ======
    async function init(){
      const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
      if(!secure){
        $('#gateMsg').innerHTML = 'Para usar la c√°mara en m√≥viles, abr√≠ esta p√°gina con <b>HTTPS</b> o desde <b>localhost</b>.';
      }
      await listCameras();
    }

    $('#btnStart').addEventListener('click', async (e)=>{
      const btn=e.currentTarget;
      btn.disabled=true; btn.textContent='Comprobando c√°mara‚Ä¶';
      diag('Abriendo stream de prueba‚Ä¶');
      try{
        await probeCamera(chosenDeviceId);
        diag('OK c√°mara. Inicializando AR‚Ä¶');
        $('#gate').style.display='none';
        buildScene();
      }catch(err){
        console.error(err);
        btn.disabled=false; btn.textContent='Activar c√°mara';
        diag('No se pudo abrir un stream de video utilizable. Revis√° permisos/HTTPS o prob√° otra c√°mara.');
      }
    });

    init();
  </script>
</body>
</html>
