<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AR Treasure ‚Äî Sacr√© Coeur</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    :root {
      color-scheme: dark;
    }

    body {
      margin: 0;
      overflow: hidden;
      font-family: "Poppins", Arial, sans-serif;
      background: #050505;
      color: #fff;
    }

    #ui {
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 9999;
      background: rgba(10, 10, 10, 0.82);
      color: white;
      padding: 14px 18px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(12px);
      max-width: 320px;
      transition: transform 0.3s ease, background 0.3s ease;
    }

    #progress {
      margin: 10px 0 12px;
      height: 6px;
      background: rgba(255, 255, 255, 0.18);
      border-radius: 3px;
      overflow: hidden;
    }

    #progressBar {
      height: 100%;
      background: linear-gradient(90deg, #27ef9f, #00c6ff);
      width: 0%;
      transition: width 0.6s ease;
    }

    #clues {
      font-size: 0.95rem;
      line-height: 1.35;
    }

    .marker-hint {
      font-size: 0.75rem;
      opacity: 0.85;
      margin-top: 6px;
      letter-spacing: 0.02em;
    }

    #audioPrompt {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 15, 15, 0.78);
      color: #fff;
      padding: 12px 22px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-size: 0.9rem;
      display: none;
      z-index: 9999;
      box-shadow: 0 16px 45px rgba(0, 0, 0, 0.45);
    }

    #audioPrompt.show {
      display: block;
    }

    #finalOverlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.92);
      color: white;
      z-index: 10000;
      flex-direction: column;
      text-align: center;
      padding: 24px;
    }

    #finalOverlay.show {
      display: flex;
      animation: fadeIn 0.55s ease;
    }

    .celebration {
      font-size: clamp(3rem, 6vw, 4.5rem);
      margin-bottom: 24px;
      animation: bounce 1.1s infinite alternate;
    }

    button {
      margin-top: 24px;
      padding: 12px 26px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #27ef9f, #00c6ff);
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 12px 25px rgba(0, 198, 255, 0.35);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 35px rgba(0, 198, 255, 0.45);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes bounce {
      from {
        transform: scale(1);
      }
      to {
        transform: scale(1.08);
      }
    }
  </style>
</head>

<body>
  <div id="ui" role="status" aria-live="polite">
    <div>üè¥‚Äç‚ò†Ô∏è Marcadores encontrados: <span id="count">0</span>/3</div>
    <div id="progress" aria-hidden="true">
      <div id="progressBar"></div>
    </div>
    <div id="clues">Escanea el marcador Hiro para comenzar la aventura...</div>
    <div class="marker-hint" id="markerHint"></div>
  </div>

  <div id="audioPrompt" role="status" aria-live="polite">
    üîä Toca la pantalla para activar el sonido.
  </div>

  <div id="finalOverlay" role="dialog" aria-modal="true">
    <div class="celebration">üéâ‚ú®</div>
    <h1>¬°Tesoro Encontrado!</h1>
    <p>¬°Felicidades! Has completado la b√∫squeda del tesoro del Sacr√© Coeur.</p>
    <p>Entrega la URL y capturas a Bruno, Maxi y Gonzalo para tu evaluaci√≥n.</p>
    <button id="closeFinal">üîÑ Jugar Nuevamente</button>
  </div>

  <!-- Escena AR -->
  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3"
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;">

    <!-- Marcador Hiro -->
    <a-marker preset="hiro" id="marker-hiro" emitevents="true">
      <a-entity position="0 0.5 0">
        <a-ring position="0 0 0" color="#27EF9F" radius-inner="0.18" radius-outer="0.22"
                rotation="-90 0 0"></a-ring>
        <a-sphere color="#00C6FF" radius="0.12" position="0 0.2 0">
          <a-animation attribute="position" direction="alternate" repeat="indefinite" to="0 0.32 0" dur="1400"></a-animation>
        </a-sphere>
        <a-text value="INICIO" position="0 0.55 0" align="center" color="#FFFFFF" width="3" scale="1.6 1.6 1.6"></a-text>
      </a-entity>
    </a-marker>

    <!-- Marcador Kanji -->
    <a-marker preset="kanji" id="marker-kanji" emitevents="true">
      <a-entity position="0 0.4 0">
        <a-cylinder position="0 0.15 0" height="0.35" radius="0.08" color="#FFD93D"></a-cylinder>
        <a-torus position="0 0.35 0" color="#FF9F1C" radius="0.16" radius-tubular="0.025"></a-torus>
        <a-entity animation="property: rotation; to: 0 360 0; loop: true; dur: 4500">
          <a-box color="#FF6B6B" depth="0.04" height="0.18" width="0.12" position="0 0.38 0"></a-box>
        </a-entity>
        <a-text value="LLAVE" position="0 0.8 0" align="center" color="#FFFFFF"></a-text>
      </a-entity>
    </a-marker>

    <!-- Marcador c√≥digo 5 -->
    <a-marker type="barcode" value="5" id="marker-codigo" emitevents="true">
      <a-entity position="0 0.5 0">
        <a-box width="0.6" height="0.3" depth="0.4" color="#8B4513"></a-box>
        <a-box width="0.58" height="0.22" depth="0.38" position="0 0.16 0" color="#D2691E"></a-box>
        <a-light type="point" intensity="2.4" color="#FFD93D" position="0 0.8 0"></a-light>
        <a-text value="TESORO" position="0 1.05 0" align="center" color="#FFD93D" scale="1.8 1.8 1.8"></a-text>
        <a-animation attribute="rotation" dur="9000" repeat="indefinite" to="0 360 0"></a-animation>
      </a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    const TOTAL_MARKERS = 3;
    const foundMarkers = new Set();

    const countEl = document.getElementById("count");
    const cluesEl = document.getElementById("clues");
    const markerHintEl = document.getElementById("markerHint");
    const progressBar = document.getElementById("progressBar");
    const finalOverlay = document.getElementById("finalOverlay");
    const audioPrompt = document.getElementById("audioPrompt");

    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
    let audioContext = null;
    let audioUnlocked = false;
    let finalPlayed = false;

    const CLUES = {
      "marker-hiro": {
        message: "¬°Bien! Has encontrado el punto de partida. Sigue con el marcador Kanji.",
        hint: "Busca cerca de la entrada principal."
      },
      "marker-kanji": {
        message: "¬°Excelente! La llave m√°gica revelar√° el cofre final.",
        hint: "Revisa junto a las zonas de estudio."
      },
      "marker-codigo": {
        message: "¬°TESORO ENCONTRADO! Has completado la misi√≥n.",
        hint: ""
      }
    };

    const MARKER_NAMES = {
      "marker-hiro": "Hiro (Inicio)",
      "marker-kanji": "Kanji (Llave)",
      "marker-codigo": "C√≥digo #5 (Tesoro)"
    };

    window.addEventListener("DOMContentLoaded", () => {
      initializeGame();
      setupAudioUnlock();
    });

    function initializeGame() {
      const markers = document.querySelectorAll("a-marker");

      markers.forEach((marker) => {
        const { id } = marker;

        marker.addEventListener("markerFound", () => {
          if (foundMarkers.has(id)) {
            return;
          }

          foundMarkers.add(id);
          console.log(`‚úÖ Marcador detectado: ${id}`);

          playPing();
          flashFeedback();
          showMarkerMessage(id);
          updateUI();

          if (foundMarkers.size === TOTAL_MARKERS) {
            setTimeout(showFinalFeedback, 800);
          }
        });

        marker.addEventListener("markerLost", () => {
          console.log(`üëã Marcador perdido: ${id}`);
        });
      });

      const closeButton = document.getElementById("closeFinal");
      if (closeButton) {
        closeButton.addEventListener("click", resetGame);
      }

      updateUI();
    }

    function setupAudioUnlock() {
      if (!AudioContextClass || !audioPrompt) {
        return;
      }

      const unlockAudio = () => {
        if (!ensureAudioContext()) {
          return;
        }

        audioUnlocked = true;
        audioPrompt.classList.remove("show");

        window.removeEventListener("click", unlockAudio);
        window.removeEventListener("touchstart", unlockAudio);
      };

      window.addEventListener("click", unlockAudio, { passive: true });
      window.addEventListener("touchstart", unlockAudio, { passive: true });

      setTimeout(() => {
        if (!audioUnlocked) {
          audioPrompt.classList.add("show");
        }
      }, 600);
    }

    function ensureAudioContext() {
      if (!AudioContextClass) {
        return null;
      }

      if (!audioContext) {
        try {
          audioContext = new AudioContextClass();
        } catch (error) {
          console.warn("No se pudo inicializar AudioContext", error);
          return null;
        }
      }

      if (audioContext.state === "suspended") {
        audioContext.resume().catch(() => {});
      }

      return audioContext;
    }

    function playTone({ frequency, duration, type = "sine", volume = 0.3, delay = 0 }) {
      const context = ensureAudioContext();
      if (!context) {
        return;
      }

      const oscillator = context.createOscillator();
      const gainNode = context.createGain();

      oscillator.type = type;
      oscillator.frequency.value = frequency;

      gainNode.gain.value = volume;
      gainNode.gain.setValueAtTime(volume, context.currentTime + delay);
      gainNode.gain.exponentialRampToValueAtTime(0.0001, context.currentTime + delay + duration);

      oscillator.connect(gainNode).connect(context.destination);

      oscillator.start(context.currentTime + delay);
      oscillator.stop(context.currentTime + delay + duration);
    }

    function playPing() {
      playTone({ frequency: 880, duration: 0.25, type: "triangle", volume: 0.3 });
      playTone({ frequency: 1320, duration: 0.2, type: "sine", volume: 0.18, delay: 0.05 });
    }

    function playCelebrationTune() {
      const melody = [
        { frequency: 659, duration: 0.25 },
        { frequency: 784, duration: 0.25 },
        { frequency: 880, duration: 0.3 },
        { frequency: 988, duration: 0.35 },
        { frequency: 1175, duration: 0.45 }
      ];

      melody.forEach((note, index) => {
        playTone({
          frequency: note.frequency,
          duration: note.duration,
          type: "sine",
          volume: 0.25,
          delay: index * 0.22
        });
      });
    }

    function showMarkerMessage(markerId) {
      const clue = CLUES[markerId];
      if (!clue) {
        return;
      }

      cluesEl.textContent = clue.message;
      markerHintEl.textContent = clue.hint;

      cluesEl.style.animation = "none";
      requestAnimationFrame(() => {
        cluesEl.style.animation = "highlight 0.6s ease";
      });
    }

    function updateUI() {
      countEl.textContent = foundMarkers.size;

      const progress = (foundMarkers.size / TOTAL_MARKERS) * 100;
      progressBar.style.width = `${progress}%`;

      if (foundMarkers.size === 0) {
        cluesEl.textContent = "Escanea el marcador Hiro para comenzar la aventura...";
        markerHintEl.textContent = "";
        return;
      }

      const foundNames = Array.from(foundMarkers).map((id) => MARKER_NAMES[id]);
      markerHintEl.textContent = `Encontrados: ${foundNames.join(", ")}`;
    }

    function flashFeedback() {
      const ui = document.getElementById("ui");
      ui.style.background = "rgba(39, 239, 159, 0.75)";
      setTimeout(() => {
        ui.style.background = "rgba(10, 10, 10, 0.82)";
      }, 280);
    }

    function showFinalFeedback() {
      if (finalPlayed) {
        return;
      }

      finalPlayed = true;
      finalOverlay.classList.add("show");

      playCelebrationTune();
      createCelebrationEffects();
    }

    function createCelebrationEffects() {
      for (let i = 0; i < 20; i++) {
        setTimeout(() => {
          const emoji = document.createElement("div");
          emoji.textContent = ["üéâ", "‚ú®", "‚≠ê", "üéä", "üí´"][Math.floor(Math.random() * 5)];
          emoji.classList.add("emoji");
          emoji.style.position = "absolute";
          emoji.style.left = Math.random() * 100 + "vw";
          emoji.style.top = "-50px";
          emoji.style.fontSize = Math.random() * 30 + 20 + "px";
          emoji.style.animation = `fall ${Math.random() * 3 + 2}s linear forwards`;
          finalOverlay.appendChild(emoji);

          setTimeout(() => emoji.remove(), 5000);
        }, i * 200);
      }
    }

    function resetGame() {
      foundMarkers.clear();
      finalPlayed = false;
      finalOverlay.classList.remove("show");

      finalOverlay.querySelectorAll(".emoji").forEach((el) => el.remove());

      updateUI();
      cluesEl.textContent = "¬°Nueva partida! Escanea el marcador Hiro.";
      markerHintEl.textContent = "";
    }

    const style = document.createElement("style");
    style.textContent = `
      @keyframes highlight {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }

      @keyframes fall {
        to {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
