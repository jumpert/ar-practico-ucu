<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>B√∫squeda del Tesoro AR ‚Äì AR.js + A‚ÄëFrame</title>
  <!-- A‚ÄëFrame (estable 1.7.1). Si tu dispositivo tiene problemas, prueba 1.6.0 -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <!-- AR.js (marker + location) para A‚ÄëFrame v3.4.7 -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
  <style>
    :root{--bg:rgba(0,0,0,.6);--ok:#2ecc71;--warn:#f1c40f;--err:#e74c3c;--txt:#fff}
    html,body{margin:0;height:100%;background:#000;}
    /* Overlay superior (estado y acciones) */
    #hud{position:fixed;inset:auto 0 0 0;top:0;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--txt);pointer-events:none}
    #left{display:flex;gap:10px;align-items:center}
    .chip{display:flex;align-items:center;gap:6px;background:var(--bg);border:1px solid rgba(255,255,255,.15);backdrop-filter:saturate(160%) blur(6px);border-radius:999px;padding:6px 10px;font-weight:600}
    .dot{width:10px;height:10px;border-radius:50%;background:#888}
    .found .dot{background:var(--ok)}
    .pending .dot{background:#888}
    #timer{background:var(--bg);border:1px solid rgba(255,255,255,.15);backdrop-filter:saturate(160%) blur(6px);border-radius:12px;padding:6px 10px;font-weight:700}
    #right{display:flex;gap:8px;pointer-events:auto}
    button{appearance:none;border:none;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer;background:#111;color:#fff;border:1px solid rgba(255,255,255,.2)}
    button:hover{filter:brightness(1.1)}
    a.btn{display:inline-flex;align-items:center;gap:8px;text-decoration:none}

    /* Pantalla de inicio para habilitar audio (iOS/Android requieren gesto) */
    #start{position:fixed;inset:0;background:radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.08), transparent 60%), #0b0f17;color:white;display:grid;place-items:center;z-index:10}
    #start .card{max-width:680px;margin:0 16px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:20px 18px;text-align:center}
    #start h1{margin-top:0;font-size:1.4rem}
    #start p{opacity:.9}
    #start button{font-size:1.1rem;padding:12px 16px;background:#2ecc71;border-color:transparent}

    /* Mensaje de victoria */
    #win{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.56);color:#fff;z-index:9}
    #win .box{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);backdrop-filter:saturate(160%) blur(8px);border-radius:18px;padding:20px 18px;text-align:center;max-width:560px;margin:0 16px}
    #win h2{margin:.2rem 0 0;font-size:1.6rem}
    #win .big{font-size:3rem}

    /* Tips m√≥viles */
    #tips{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:var(--bg);color:#fff;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:8px 12px;font-size:.9rem}
  </style>
</head>
<body>
  <!-- Pantalla de inicio para conceder c√°mara y audio -->
  <div id="start" role="dialog" aria-modal="true">
    <div class="card">
      <h1>üîé B√∫squeda del Tesoro AR</h1>
      <p>Escane√° 3 marcadores <strong>(Hiro, Kanji y Letra A)</strong> en cualquier orden. Al ver cada marcador se desbloquea una pista. Cuando encuentres los 3, ¬°aparece el tesoro!<br>Si necesit√°s marcadores de prueba, toc√° ‚ÄúAbrir marcadores‚Äù.</p>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:10px">
        <a class="btn" target="_blank" rel="noopener" href="https://commons.wikimedia.org/wiki/File:Hiro_Kanji_3Markers.pdf">üìÑ Abrir marcadores (PDF)</a>
        <a class="btn" target="_blank" rel="noopener" href="https://jeromeetienne.github.io/AR.js/three.js/examples/marker-training/examples/generator.html">üñ®Ô∏è Generar marcador propio</a>
      </div>
      <p style="margin:.6rem 0 1.2rem;opacity:.85">Consejo: buena luz y marcador plano. Evit√° reflejos.</p>
      <button id="btnStart">üé¨ Comenzar</button>
    </div>
  </div>

  <!-- HUD -->
  <div id="hud" aria-live="polite">
    <div id="left">
      <div class="chip pending" id="chip-hiro"><span class="dot"></span><span>Hiro</span></div>
      <div class="chip pending" id="chip-kanji"><span class="dot"></span><span>Kanji</span></div>
      <div class="chip pending" id="chip-letter"><span class="dot"></span><span>Letra A</span></div>
    </div>
    <div id="timer">00:00</div>
    <div id="right">
      <a class="btn" target="_blank" rel="noopener" href="https://commons.wikimedia.org/wiki/File:Hiro_Kanji_3Markers.pdf">üì• PDF marcadores</a>
      <button id="btnReset">‚Ü∫ Reiniciar</button>
    </div>
  </div>

  <!-- Mensaje de victoria -->
  <div id="win">
    <div class="box">
      <div class="big">üéâ</div>
      <h2>¬°Tesoro descubierto!</h2>
      <p id="winTime" style="margin:.2rem 0 .6rem;opacity:.9"></p>
      <p style="opacity:.9">Escane√° de nuevo o toc√° <strong>Reiniciar</strong> para volver a empezar.</p>
    </div>
  </div>

  <div id="tips">üí° Si la c√°mara se ve negra, cerr√° otras apps que usen la c√°mara y recarg√° la p√°gina.</div>

  <!-- Escena AR -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="alpha: true; antialias: true; logarithmicDepthBuffer: true"
    embedded
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;" >

    <!-- Luz general para colores vivos en m√≥viles -->
    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="-1 1 0"></a-entity>

    <!-- Marcador 1: HIRO (presentaci√≥n) -->
    <a-marker id="marker-hiro" preset="hiro">
      <a-entity position="0 0 0">
        <a-box depth="0.2" height="0.2" width="0.2" color="#29b6f6" position="0 0.1 0" animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear"></a-box>
        <a-text value="Bienvenido\nEscane√° los otros\nmarcadores" align="center" color="#ffffff" position="0 0.05 0" rotation="-90 0 0" width="1.8"></a-text>
      </a-entity>
    </a-marker>

    <!-- Marcador 2: KANJI (pista 1) -->
    <a-marker id="marker-kanji" preset="kanji">
      <a-entity position="0 0 0">
        <a-torus-knot radius="0.2" radius-tubular="0.05" color="#f39c12" position="0 0.15 0" animation="property: rotation; to: 360 360 0; loop: true; dur: 4500; easing: linear"></a-torus-knot>
        <a-text value="Pista 1:\nBusc√° la letra secreta" align="center" color="#ffeaa7" position="0 0.02 0" rotation="-90 0 0" width="1.8"></a-text>
      </a-entity>
    </a-marker>

    <!-- Marcador 3: Patr√≥n adicional (Letra A) -->
    <a-marker id="marker-letter" type="pattern" url="https://designheritage.mit.edu/_dh_debug/ARjs/ARjs_210212_nicolocarpignoli/three.js/examples/marker-training/examples/pattern-files/pattern-letterA.patt">
      <a-entity position="0 0 0">
        <a-sphere radius="0.12" color="#2ecc71" position="0 0.15 0"></a-sphere>
        <a-box depth="0.02" height="0.02" width="0.6" color="#2ecc71" position="0 0.03 0" rotation="-90 0 0"></a-box>
        <a-text value="Pista 2:\n¬°Encontraste la letra!" align="center" color="#a3e4d7" position="0 0.02 0" rotation="-90 0 0" width="1.8"></a-text>
      </a-entity>
    </a-marker>

    <!-- C√°mara -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // Estado del juego
    const state = {
      started: false,
      t0: 0,
      timerRef: null,
      found: { hiro:false, kanji:false, letter:false },
      completed: false,
      audioCtx: null
    };

    const $ = (sel) => document.querySelector(sel);

    const updateChips = () => {
      $("#chip-hiro").classList.toggle("found", state.found.hiro);
      $("#chip-kanji").classList.toggle("found", state.found.kanji);
      $("#chip-letter").classList.toggle("found", state.found.letter);
      $("#chip-hiro").classList.toggle("pending", !state.found.hiro);
      $("#chip-kanji").classList.toggle("pending", !state.found.kanji);
      $("#chip-letter").classList.toggle("pending", !state.found.letter);
    }

    const fmt = (ms) => {
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const r = s % 60;
      return String(m).padStart(2,'0') + ':' + String(r).padStart(2,'0');
    }

    const startTimer = () => {
      state.t0 = Date.now();
      $("#timer").textContent = '00:00';
      clearInterval(state.timerRef);
      state.timerRef = setInterval(() => {
        if(!state.started || state.completed) return;
        $("#timer").textContent = fmt(Date.now() - state.t0);
      }, 200);
    }

    const playWinSound = () => {
      try{
        const ctx = state.audioCtx || (state.audioCtx = new (window.AudioContext||window.webkitAudioContext)());
        const now = ctx.currentTime;
        const notes = [523.25, 659.25, 783.99, 1046.5]; // C5 E5 G5 C6
        notes.forEach((f,i)=>{
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine'; o.frequency.value = f; o.connect(g); g.connect(ctx.destination);
          g.gain.setValueAtTime(0.0001, now + i*0.12);
          g.gain.exponentialRampToValueAtTime(0.4, now + i*0.12 + 0.02);
          g.gain.exponentialRampToValueAtTime(0.001, now + i*0.12 + 0.35);
          o.start(now + i*0.12); o.stop(now + i*0.12 + 0.36);
        });
      }catch(e){ /* no-op */ }
    }

    const checkWin = () => {
      if(state.completed) return;
      if(state.found.hiro && state.found.kanji && state.found.letter){
        state.completed = true;
        const elapsed = Date.now() - state.t0;
        $("#winTime").textContent = `Tiempo: ${fmt(elapsed)}`;
        $("#win").style.display = 'grid';
        playWinSound();
      }
    }

    const resetGame = () => {
      state.started = false; state.completed = false; state.found = {hiro:false,kanji:false,letter:false};
      updateChips();
      $("#win").style.display = 'none';
      $("#timer").textContent = '00:00';
      $("#start").style.display = 'grid';
    }

    // Habilitar por gesto (audio y permisos) y arrancar timer
    $("#btnStart").addEventListener('click', async () => {
      try{ state.audioCtx = new (window.AudioContext||window.webkitAudioContext)(); await state.audioCtx.resume(); }catch(e){}
      state.started = true; startTimer(); updateChips(); $("#start").style.display = 'none';
    });

    $("#btnReset").addEventListener('click', resetGame);

    // Listeners markerFound / markerLost
    const onFound = (key) => () => { if(!state.started) return; state.found[key] = true; updateChips(); checkWin(); };

    document.addEventListener('DOMContentLoaded', () => {
      $("#marker-hiro").addEventListener('markerFound', onFound('hiro'));
      $("#marker-kanji").addEventListener('markerFound', onFound('kanji'));
      $("#marker-letter").addEventListener('markerFound', onFound('letter'));
      // Opcional: pod√©s escuchar markerLost si quer√©s feedback adicional
      // $("#marker-hiro").addEventListener('markerLost', () => console.log('Hiro perdido'))
    });
  </script>
</body>
</html>
